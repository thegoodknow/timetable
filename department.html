<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Status</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    
    <style>
        /* --- DEPARTMENT STATUS COLORS --- */
        .closed-tag {
            background-color: #dc3545; /* Red */
            color: var(--text-light);
        }
        .open-tag {
            background-color: #28a745; /* Green */
            color: var(--text-light);
        }
        .closing-soon-tag {
            background-color: var(--color-current, #FFC107); /* Yellow/Amber */
            color: var(--bg-dark); 
        }

        /* --- Custom Header Fix: Ensures layout remains correct after removing controls-group --- */
        .header {
            justify-content: space-between; 
            padding-left: 20px; 
            padding-right: 20px;
        }
        
        /* --- CARD STYLES --- */
        #departments-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px 0;
        }
        .class-card {
            background-color: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid transparent;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: border-left-color 0.3s;
            position: relative; 
        }
        .class-card.today {
            border-left-color: var(--color-primary); 
        }
        .card-title {
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-light);
        }
        .card-title .material-icons {
            margin-right: 8px;
        }
        .pill {
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-light);
        }
        .card-subtitle {
            color: var(--text-subtle);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        /* Maintenance/Announcement Banner Style */
        .shop-tag {
            background-color: #FFC107;  /* Orange */
            color: white;
        margin-left: 10px;
        font-weight: 700;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="logo-group">
            <div class="logo">
                <img id="logo-icon" src="apspace-white.svg" alt="Logo">
            </div>
        </div>

        <div class="header-summary-bar">
            <span id="current-clock" class="summary-item clock-display">Loading Time...</span>
            
            <span id="next-class-display" class="summary-item next-class-display">
                <span class="material-icons">business_center</span> Loading Department Status...
            </span>
        </div>
        
    </div>

    <div class="timetable-content" id="timetable-list">
        <main class="content-area">
            <h2>APU Department Availability Status</h2>
            <div id="departments-list">
                <p style="padding: 20px; text-align: center; color: var(--text-subtle);">Initializing application...</p>
            </div>
        </main>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Department Operating Hours Configuration ---
    const DEPARTMENTS = [
        { 
            name: "Admin", 
            shop: false,
            schedule: [ 
                { days: [1, 2, 3, 4, 5], start: { h: 8, m: 30 }, end: { h: 18, m: 0 } },
            ] 
        },
        { 
            name: "Cashier", 
            shop: false,
            schedule: [ 
                { days: [1, 2, 3, 4, 5], start: { h: 9, m: 15 }, end: { h: 18, m: 0 } } 
            ] 
        },
        { 
            name: "Clinic", 
            shop: false,
            schedule: [ 
                { days: [1, 2, 3, 4, 5], start: { h: 9, m: 0 }, end: { h: 17, m: 0 } }
            ] 
        },
        { 
            name: "Student Service", 
            shop: false,
            schedule: [ 
                { days: [1, 2, 3, 4, 5], start: { h: 8, m: 30 }, end: { h: 19, m: 0 } },
                { days: [6], start: { h: 8, m: 30 }, end: { h: 13, m: 0 } }
            ]
        },
        { 
            name: "Library", 
            shop: false,
            schedule: [ 
                { days: [1, 2, 3, 4, 5], start: { h: 8, m: 30 }, end: { h: 19, m: 0 } },
                { days: [6], start: { h: 9, m: 0 }, end: { h: 13, m: 0 } }
            ] 
        },
        { 
            name: "Technology Labs", 
            shop: false,
            schedule: [
                { days: [1, 2, 3, 4, 5], start: { h: 8, m: 30 }, end: { h: 19, m: 0 } },
                { days: [6], start: { h: 9, m: 0 }, end: { h: 13, m: 0 } }
            ]
        },
        { 
            name: "Bila-Bila Mart", 
            shop: true,
            schedule: [
                { days: [1,2,3,4,5,6,0], start: { h: 7, m: 0 }, end: { h: 23, m: 59 } }
            ] 
        },
        { 
            name: "TS Convenience Store",
            shop: true, 
            schedule: [ 
                { days: [1,2,3,4,5,6,0], start: { h: 7, m: 30 }, end: { h: 20, m: 30 } }
            ]
        }
    ];
    
    const CLOSING_SOON_THRESHOLD_MINUTES = 30;
    const DAY_NAMES = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

    const currentClock = document.getElementById('current-clock');
    const departmentStatusDisplay = document.getElementById('next-class-display');
    const departmentsList = document.getElementById('departments-list');

    // Utility formatting functions
    const formatTime = ({h, m}) => {
        const ampm = h >= 12 ? 'PM' : 'AM';
        const hour = h % 12 || 12;
        const min = m.toString().padStart(2, '0');
        return `${hour}:${min} ${ampm}`;
    };

    function formatDaysDisplay(schedule) {
        return schedule.map(item => {
            const days = item.days.map(d => DAY_NAMES[d].substring(0,3));
            let dayRange;

            if (item.days.length === 5 && item.days[0] === 1 && item.days[4] === 5) {
                dayRange = "Mon-Fri";
            } else if (item.days.length === 1) {
                dayRange = days[0];
            } else {
                dayRange = `${days[0]}-${days[days.length - 1]}`;
            }

            return `[${dayRange}]: ${formatTime(item.start)} - ${formatTime(item.end)}`;
        }).join(' | ');
    }


    function getOperationTime(dept, now) {
        const day = now.getDay();
        return dept.schedule.find(s => s.days.includes(day)) || null;
    }

    function isDepartmentOpen(dept, now) {
        const sched = getOperationTime(dept, now);
        if (!sched) return false;

        const mins = now.getHours() * 60 + now.getMinutes();
        const openM = sched.start.h * 60 + sched.start.m;
        const closeM = sched.end.h * 60 + sched.end.m;

        return mins >= openM && mins < closeM;
    }

    function getNextOpeningTime(dept, now) {
    const currentDay = now.getDay();
    const currentMins = now.getHours() * 60 + now.getMinutes();

    for (let i = 0; i < 7; i++) {
        const checkDay = (currentDay + i) % 7;

        const sched = dept.schedule.find(s => s.days.includes(checkDay));
        if (!sched) continue;

        const openM = sched.start.h * 60 + sched.start.m;

        // Today but not yet opened
        if (i === 0 && currentMins < openM) {
            return `Today at ${formatTime(sched.start)}`;
        }

        // Tomorrow
        if (i === 1) {
            return `Tomorrow at ${formatTime(sched.start)}`;
        }

        // Other days
        if (i > 1) {
            return `${DAY_NAMES[checkDay]} at ${formatTime(sched.start)}`;
        }
    }

    return "Indefinitely Closed";
}



    function updateDepartmentStatus() {
        const now = new Date();
        const openDepartments = [];
        const closingSoonDepartments = [];
        const fullyOpenDepartments = [];

        departmentsList.innerHTML = ''; 

        DEPARTMENTS.forEach(dept => {
            let statusClass = 'closed-tag';
            let statusText = 'CLOSED';

            const currentSchedule = getOperationTime(dept, now);
            const isCurrentlyOpen = isDepartmentOpen(dept, now);

            if (isCurrentlyOpen) {
                const closingTime = new Date(now);
                closingTime.setHours(currentSchedule.end.h, currentSchedule.end.m, 0, 0);

                const timeRemainingMs = closingTime - now;
                const timeRemainingMins = Math.floor(timeRemainingMs / 60000);

                if (timeRemainingMins <= CLOSING_SOON_THRESHOLD_MINUTES) {
                    statusClass = 'closing-soon-tag';
                    statusText = `CLOSES IN ${timeRemainingMins}m`;
                    closingSoonDepartments.push(dept.name);
                } else {
                    statusClass = 'open-tag';
                    statusText = 'OPEN';
                    fullyOpenDepartments.push(dept.name);
                }

                openDepartments.push(dept.name);
            }

            let subtitleContent = formatDaysDisplay(dept.schedule);

            if (!isCurrentlyOpen) {
                const nextOpenTime = getNextOpeningTime(dept, now);
                subtitleContent += `<br/>Next Opening: <strong>${nextOpenTime}</strong>`;
            }

            const card = document.createElement('div');
            card.className = `class-card ${isCurrentlyOpen ? 'today' : ''}`;

            const pillHtml = `<span class="pill ${statusClass}">${statusText}</span>`;

            card.innerHTML = `
                <div class="card-title">
                    <span class="material-icons inperson-icon">business</span>
                    ${dept.name} 
                    ${dept.shop ? `<span class="pill shop-tag">SHOP</span>` : ""}
                    ${pillHtml}
                </div>
                <div class="card-subtitle">
                    ${subtitleContent}
                </div>
            `;


            departmentsList.appendChild(card);
        });

        // ---------- HEADER SUMMARY ----------
        let headerHtml = '';
        const green = '#28a745';
        const red = '#dc3545';
        const yellow = 'var(--color-current)';

        const allOpen = openDepartments.length === DEPARTMENTS.length;
        const allClosed = openDepartments.length === 0;

        if (allOpen) {
            headerHtml = `
                <span class="material-icons" style="color:${green}">check_circle</span>
                <span style="color:${green};font-weight:700">All departments are available</span>
            `;
        } else if (allClosed) {
            headerHtml = `
                <span class="material-icons" style="color:${red}">lock_clock</span>
                <span style="color:${red};font-weight:700">All departments are currently closed</span>
            `;
        } else {
            const closingSoonList = closingSoonDepartments.length > 0
                ? `<br><strong>Closing Soon:</strong> ${closingSoonDepartments.join(', ')}`
                : '';

            const stillOpenList = fullyOpenDepartments.length > 0
                ? `<br><strong>Still Open:</strong> ${fullyOpenDepartments.join(', ')}`
                : '';

            headerHtml = `
                <span class="material-icons" style="color:${yellow}">schedule</span>
                <span style="color:${yellow};font-weight:700">Some department are closing soon... | </span>
                 ${closingSoonList} & 
                 ${stillOpenList}
            `;
        }

        departmentStatusDisplay.innerHTML = headerHtml;
    }


    function updateClock() {
        const now = new Date();
        currentClock.textContent = now.toLocaleTimeString("en-US", {
            hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: true
        });
    }

    // ---------------- FIXED TIMERS ----------------

    // Update clock every second
    setInterval(updateClock, 1000);

    // Update department status every 30 seconds (NO MORE FREEZING)
    setInterval(updateDepartmentStatus, 30000);

    // Initial load
    updateClock();
    updateDepartmentStatus();
});

</script>
</body>
</html>